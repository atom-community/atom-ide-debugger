"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var React = _interopRequireWildcard(require("react"));

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _Button = require("@atom-ide-community/nuclide-commons-ui/Button");

var _ButtonGroup = require("@atom-ide-community/nuclide-commons-ui/ButtonGroup");

var _Dropdown = require("@atom-ide-community/nuclide-commons-ui/Dropdown");

var _Tabs = _interopRequireDefault(require("@atom-ide-community/nuclide-commons-ui/Tabs"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _assert = _interopRequireDefault(require("assert"));

var _AtomServiceContainer = require("../AtomServiceContainer");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/* global localStorage */
// TODO those should be managed by the debugger store state
function setLastUsedDebugger(host, action, debuggerDisplayName) {
  const key = "DEBUGGER_LAST_USED_" + host + "_" + action;
  localStorage.setItem(key, debuggerDisplayName);
}

function getLastUsedDebugger(host, action) {
  const key = "DEBUGGER_LAST_USED_" + host + "_" + action;
  return localStorage.getItem(key);
} // Older published debugger packages did not provide `getTabName()`.
// TODO(most): Remove this once newer debugger versions get adoption.


function getTabName(provider) {
  var _provider$_debuggingT;

  if (typeof provider.getTabName === "function") {
    return provider.getTabName();
  }

  return (_provider$_debuggingT = provider._debuggingTypeName) !== null && _provider$_debuggingT !== void 0 ? _provider$_debuggingT : "";
}

class DebuggerLaunchAttachUI extends React.Component {
  constructor(props) {
    super(props);
    this.props = void 0;
    this.state = void 0;
    this._disposables = void 0;

    this._setConfigValid = valid => {
      this.setState({
        configIsValid: valid
      });
    };

    this._disposables = new _UniversalDisposable.default();

    this._disposables.add(atom.commands.add("atom-workspace", {
      "core:confirm": () => {
        if (this.state.configIsValid) {
          this._rememberTab(); // Close the dialog, but do it on the next tick so that the child
          // component gets to handle the event first (and start the debugger).


          process.nextTick(this.props.dialogCloser);
        }
      }
    }), atom.commands.add("atom-workspace", {
      "core:cancel": () => {
        this._rememberTab();

        this.props.dialogCloser();
      }
    }));

    this.state = {
      selectedProviderTab: null,
      configIsValid: false,
      enabledProviders: []
    };
  }

  _rememberTab() {
    // Remember the last tab the user used for this connection when the "launch/attach"
    // button is clicked.
    const host = _nuclideUri.default.isRemote(this.props.connection) ? _nuclideUri.default.getHostname(this.props.connection) : "local";

    if (this.state.selectedProviderTab != null) {
      setLastUsedDebugger(host, this.props.dialogMode, this.state.selectedProviderTab || "");
    }
  }

  UNSAFE_componentWillMount() {
    const host = _nuclideUri.default.isRemote(this.props.connection) ? _nuclideUri.default.getHostname(this.props.connection) : "local";
    const selectedProvider = (this.props.providers.get(host) || []).find(p => getTabName(p) === this.props.initialSelectedTabName);

    if (selectedProvider != null) {
      setLastUsedDebugger(host, this.props.dialogMode, getTabName(selectedProvider));
    }

    this._filterProviders(host);

    this.setState({
      selectedProviderTab: getLastUsedDebugger(host, this.props.dialogMode)
    });
  }

  UNSAFE_componentWillReceiveProps(nextProps) {
    const host = _nuclideUri.default.isRemote(nextProps.connection) ? _nuclideUri.default.getHostname(nextProps.connection) : "local";

    this._filterProviders(host);

    this.setState({
      selectedProviderTab: getLastUsedDebugger(host, nextProps.dialogMode)
    });
  }

  componentWillUnmount() {
    this._disposables.dispose();
  }

  async _getProviderIfEnabled(provider) {
    const enabled = await provider.getCallbacksForAction(this.props.dialogMode).isEnabled();
    return enabled ? provider : null;
  }

  _filterProviders(key) {
    this.setState({
      enabledProviders: []
    }); // eslint-disable-next-line nuclide-internal/unused-subscription

    _rxjsCompatUmdMin.Observable.merge(...(this.props.providers.get(key) || []).map(provider => _rxjsCompatUmdMin.Observable.fromPromise(this._getProviderIfEnabled(provider)))).filter(provider => provider != null).map(provider => {
      (0, _assert.default)(provider != null);
      const tabName = getTabName(provider);
      return {
        provider,
        tabName
      };
    }).scan((arr, provider) => arr.concat(provider), []).subscribe(enabledProviders => {
      this.setState({
        enabledProviders
      });
    });
  }

  _getTabsFromEnabledProviders(enabledProviders) {
    const tabs = this.state.enabledProviders.map(debuggerType => ({
      name: debuggerType.tabName,
      tabContent: /*#__PURE__*/React.createElement("span", {
        title: debuggerType.tabName,
        className: "debugger-provider-tab"
      }, debuggerType.tabName)
    })).sort((a, b) => a.name.localeCompare(b.name));
    return tabs;
  }

  setState(partialState, callback) {
    if (typeof partialState === "function") {
      super.setState(partialState, callback);
    } else {
      const fullState = { ...this.state,
        ...partialState
      };

      if (fullState.selectedProviderTab == null) {
        const tabs = this._getTabsFromEnabledProviders(fullState.enabledProviders);

        if (tabs.length > 0) {
          const firstTab = tabs[0];
          fullState.selectedProviderTab = firstTab.name;
        }
      }

      super.setState(fullState, callback);
    }
  }

  render() {
    const tabs = this._getTabsFromEnabledProviders(this.state.enabledProviders);

    let providerContent = null;

    if (tabs.length > 0) {
      let selectedTab = this.state.selectedProviderTab != null ? this.state.selectedProviderTab : this.state.enabledProviders[0].tabName;
      let provider = this.state.enabledProviders.find(p => p.tabName === selectedTab);

      if (provider == null) {
        provider = this.state.enabledProviders[0];
        selectedTab = provider.tabName;
      }

      const defaultConfig = selectedTab != null && selectedTab === this.props.initialSelectedTabName ? this.props.initialProviderConfig : null;
      const debuggerConfigPage = provider.provider.getCallbacksForAction(this.props.dialogMode).getComponent(selectedTab, valid => this._setConfigValid(valid), defaultConfig);
      providerContent = /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement(_Tabs.default, {
        className: "debugger-launch-attach-tabs",
        tabs: tabs,
        growable: true,
        activeTabName: this.state.selectedProviderTab,
        triggeringEvent: "onClick",
        onActiveTabChange: newTab => {
          this._setConfigValid(false);

          this.setState({
            selectedProviderTab: newTab.name
          });
        }
      }), /*#__PURE__*/React.createElement("div", {
        className: "debugger-launch-attach-tabcontent"
      }, debuggerConfigPage));
    } else {
      // No debugging providers available.
      providerContent = /*#__PURE__*/React.createElement("div", {
        className: "debugger-launch-attach-tabcontent"
      }, "No debuggers installed, look for available debuggers on", " ", /*#__PURE__*/React.createElement("a", {
        href: "https://atom.io/packages/search?q=atom-ide-debugger-"
      }, "atom.io/packages"));
    }

    return /*#__PURE__*/React.createElement("div", {
      className: "padded debugger-launch-attach-container"
    }, (0, _AtomServiceContainer.isNuclideEnvironment)() ? /*#__PURE__*/React.createElement("h1", {
      className: "debugger-launch-attach-header"
    }, /*#__PURE__*/React.createElement("span", {
      className: "padded"
    }, this.props.dialogMode === "attach" ? "Attach debugger to " : "Launch debugger on "), /*#__PURE__*/React.createElement(_Dropdown.Dropdown, {
      className: "inline",
      options: this.props.connectionOptions,
      onChange: value => this.props.connectionChanged(value),
      size: "xs",
      value: this.props.connection
    })) : null, providerContent, /*#__PURE__*/React.createElement("div", {
      className: "debugger-launch-attach-actions"
    }, /*#__PURE__*/React.createElement(_ButtonGroup.ButtonGroup, null, /*#__PURE__*/React.createElement(_Button.Button, {
      onClick: () => atom.commands.dispatch(atom.views.getView(atom.workspace), "core:cancel")
    }, "Cancel"), /*#__PURE__*/React.createElement(_Button.Button, {
      buttonType: _Button.ButtonTypes.PRIMARY,
      disabled: !this.state.configIsValid,
      onClick: () => atom.commands.dispatch(atom.views.getView(atom.workspace), "core:confirm")
    }, this.props.dialogMode === "attach" ? "Attach" : "Launch"))));
  }

}

exports.default = DebuggerLaunchAttachUI;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRlYnVnZ2VyTGF1bmNoQXR0YWNoVUkuanMiXSwibmFtZXMiOlsic2V0TGFzdFVzZWREZWJ1Z2dlciIsImhvc3QiLCJhY3Rpb24iLCJkZWJ1Z2dlckRpc3BsYXlOYW1lIiwia2V5IiwibG9jYWxTdG9yYWdlIiwic2V0SXRlbSIsImdldExhc3RVc2VkRGVidWdnZXIiLCJnZXRJdGVtIiwiZ2V0VGFiTmFtZSIsInByb3ZpZGVyIiwiX2RlYnVnZ2luZ1R5cGVOYW1lIiwiRGVidWdnZXJMYXVuY2hBdHRhY2hVSSIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsInN0YXRlIiwiX2Rpc3Bvc2FibGVzIiwiX3NldENvbmZpZ1ZhbGlkIiwidmFsaWQiLCJzZXRTdGF0ZSIsImNvbmZpZ0lzVmFsaWQiLCJVbml2ZXJzYWxEaXNwb3NhYmxlIiwiYWRkIiwiYXRvbSIsImNvbW1hbmRzIiwiX3JlbWVtYmVyVGFiIiwicHJvY2VzcyIsIm5leHRUaWNrIiwiZGlhbG9nQ2xvc2VyIiwic2VsZWN0ZWRQcm92aWRlclRhYiIsImVuYWJsZWRQcm92aWRlcnMiLCJudWNsaWRlVXJpIiwiaXNSZW1vdGUiLCJjb25uZWN0aW9uIiwiZ2V0SG9zdG5hbWUiLCJkaWFsb2dNb2RlIiwiVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCIsInNlbGVjdGVkUHJvdmlkZXIiLCJwcm92aWRlcnMiLCJnZXQiLCJmaW5kIiwicCIsImluaXRpYWxTZWxlY3RlZFRhYk5hbWUiLCJfZmlsdGVyUHJvdmlkZXJzIiwiVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiLCJuZXh0UHJvcHMiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsImRpc3Bvc2UiLCJfZ2V0UHJvdmlkZXJJZkVuYWJsZWQiLCJlbmFibGVkIiwiZ2V0Q2FsbGJhY2tzRm9yQWN0aW9uIiwiaXNFbmFibGVkIiwiT2JzZXJ2YWJsZSIsIm1lcmdlIiwibWFwIiwiZnJvbVByb21pc2UiLCJmaWx0ZXIiLCJ0YWJOYW1lIiwic2NhbiIsImFyciIsImNvbmNhdCIsInN1YnNjcmliZSIsIl9nZXRUYWJzRnJvbUVuYWJsZWRQcm92aWRlcnMiLCJ0YWJzIiwiZGVidWdnZXJUeXBlIiwibmFtZSIsInRhYkNvbnRlbnQiLCJzb3J0IiwiYSIsImIiLCJsb2NhbGVDb21wYXJlIiwicGFydGlhbFN0YXRlIiwiY2FsbGJhY2siLCJmdWxsU3RhdGUiLCJsZW5ndGgiLCJmaXJzdFRhYiIsInJlbmRlciIsInByb3ZpZGVyQ29udGVudCIsInNlbGVjdGVkVGFiIiwiZGVmYXVsdENvbmZpZyIsImluaXRpYWxQcm92aWRlckNvbmZpZyIsImRlYnVnZ2VyQ29uZmlnUGFnZSIsImdldENvbXBvbmVudCIsIm5ld1RhYiIsImNvbm5lY3Rpb25PcHRpb25zIiwidmFsdWUiLCJjb25uZWN0aW9uQ2hhbmdlZCIsImRpc3BhdGNoIiwidmlld3MiLCJnZXRWaWV3Iiwid29ya3NwYWNlIiwiQnV0dG9uVHlwZXMiLCJQUklNQVJZIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBZEE7QUE0Q0E7QUFDQSxTQUFTQSxtQkFBVCxDQUE2QkMsSUFBN0IsRUFBMkNDLE1BQTNDLEVBQXlFQyxtQkFBekUsRUFBNEc7QUFDMUcsUUFBTUMsR0FBRyxHQUFHLHdCQUF3QkgsSUFBeEIsR0FBK0IsR0FBL0IsR0FBcUNDLE1BQWpEO0FBQ0FHLEVBQUFBLFlBQVksQ0FBQ0MsT0FBYixDQUFxQkYsR0FBckIsRUFBMEJELG1CQUExQjtBQUNEOztBQUVELFNBQVNJLG1CQUFULENBQTZCTixJQUE3QixFQUEyQ0MsTUFBM0MsRUFBa0Y7QUFDaEYsUUFBTUUsR0FBRyxHQUFHLHdCQUF3QkgsSUFBeEIsR0FBK0IsR0FBL0IsR0FBcUNDLE1BQWpEO0FBQ0EsU0FBT0csWUFBWSxDQUFDRyxPQUFiLENBQXFCSixHQUFyQixDQUFQO0FBQ0QsQyxDQUVEO0FBQ0E7OztBQUNB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T0FBTyxFQUFFLE1BQU1HLElBQUksQ0FBQ0MsUUFBTCxDQUFjK0QsUUFBZCxDQUF1QmhFLElBQUksQ0FBQ2lFLEtBQUwsQ0FBV0MsT0FBWCxDQUFtQmxFLElBQUksQ0FBQ21FLFNBQXhCLENBQXZCLEVBQTJELGNBQTNEO0FBSGpCLE9BS0csS0FBSzVFLEtBQUwsQ0FBV3FCLFVBQVgsS0FBMEIsUUFBMUIsR0FBcUMsUUFBckMsR0FBZ0QsUUFMbkQsQ0FKRixDQURGLENBaEJGLENBREY7QUFpQ0Q7O0FBL04rRSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBsb2NhbFN0b3JhZ2UgKi9cclxuXHJcbmltcG9ydCB0eXBlIHsgRGVidWdnZXJDb25maWdBY3Rpb24sIERlYnVnZ2VyTGF1bmNoQXR0YWNoUHJvdmlkZXIgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWRlYnVnZ2VyLWNvbW1vblwiXHJcbmltcG9ydCB0eXBlIHsgVGFiIH0gZnJvbSBcIkBhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zLXVpL1RhYnNcIlxyXG5cclxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSBcInJlYWN0XCJcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSBcIkBhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL1VuaXZlcnNhbERpc3Bvc2FibGVcIlxyXG5pbXBvcnQgbnVjbGlkZVVyaSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaVwiXHJcbmltcG9ydCB7IEJ1dHRvbiwgQnV0dG9uVHlwZXMgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtdWkvQnV0dG9uXCJcclxuaW1wb3J0IHsgQnV0dG9uR3JvdXAgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtdWkvQnV0dG9uR3JvdXBcIlxyXG5pbXBvcnQgeyBEcm9wZG93biB9IGZyb20gXCJAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy11aS9Ecm9wZG93blwiXHJcbmltcG9ydCBUYWJzIGZyb20gXCJAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy11aS9UYWJzXCJcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gXCJyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanNcIlxyXG5pbXBvcnQgaW52YXJpYW50IGZyb20gXCJhc3NlcnRcIlxyXG5pbXBvcnQgeyBpc051Y2xpZGVFbnZpcm9ubWVudCB9IGZyb20gXCIuLi9BdG9tU2VydmljZUNvbnRhaW5lclwiXHJcblxyXG50eXBlIENvbm5lY3Rpb25PcHRpb24gPSB7XHJcbiAgdmFsdWU6IHN0cmluZyxcclxuICBsYWJlbDogc3RyaW5nLFxyXG59XHJcblxyXG50eXBlIEVuYWJsZWRQcm92aWRlciA9IHtcclxuICBwcm92aWRlcjogRGVidWdnZXJMYXVuY2hBdHRhY2hQcm92aWRlcixcclxuICB0YWJOYW1lOiBzdHJpbmcsXHJcbn1cclxuXHJcbnR5cGUgUHJvcHMgPSB7XHJcbiAgK2RpYWxvZ01vZGU6IERlYnVnZ2VyQ29uZmlnQWN0aW9uLFxyXG4gICtpbml0aWFsU2VsZWN0ZWRUYWJOYW1lOiA/c3RyaW5nLFxyXG4gICtpbml0aWFsUHJvdmlkZXJDb25maWc6ID97IFtzdHJpbmddOiBtaXhlZCB9LFxyXG4gICtjb25uZWN0aW9uOiBzdHJpbmcsXHJcbiAgK2Nvbm5lY3Rpb25DaGFuZ2VkOiAobmV3VmFsdWU6ID9zdHJpbmcpID0+IHZvaWQsXHJcbiAgLy8gJEZsb3dGaXhNZVxyXG4gICtjb25uZWN0aW9uT3B0aW9uczogQXJyYXk8Q29ubmVjdGlvbk9wdGlvbj4sXHJcbiAgK3Byb3ZpZGVyczogTWFwPHN0cmluZywgQXJyYXk8RGVidWdnZXJMYXVuY2hBdHRhY2hQcm92aWRlcj4+LFxyXG4gICtkaWFsb2dDbG9zZXI6ICgpID0+IHZvaWQsXHJcbn1cclxuXHJcbnR5cGUgU3RhdGUgPSB7XHJcbiAgc2VsZWN0ZWRQcm92aWRlclRhYjogP3N0cmluZyxcclxuICBjb25maWdJc1ZhbGlkOiBib29sZWFuLFxyXG4gIGVuYWJsZWRQcm92aWRlcnM6IEFycmF5PEVuYWJsZWRQcm92aWRlcj4sXHJcbn1cclxuXHJcbi8vIFRPRE8gdGhvc2Ugc2hvdWxkIGJlIG1hbmFnZWQgYnkgdGhlIGRlYnVnZ2VyIHN0b3JlIHN0YXRlXHJcbmZ1bmN0aW9uIHNldExhc3RVc2VkRGVidWdnZXIoaG9zdDogc3RyaW5nLCBhY3Rpb246IERlYnVnZ2VyQ29uZmlnQWN0aW9uLCBkZWJ1Z2dlckRpc3BsYXlOYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICBjb25zdCBrZXkgPSBcIkRFQlVHR0VSX0xBU1RfVVNFRF9cIiArIGhvc3QgKyBcIl9cIiArIGFjdGlvblxyXG4gIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgZGVidWdnZXJEaXNwbGF5TmFtZSlcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0TGFzdFVzZWREZWJ1Z2dlcihob3N0OiBzdHJpbmcsIGFjdGlvbjogRGVidWdnZXJDb25maWdBY3Rpb24pOiA/c3RyaW5nIHtcclxuICBjb25zdCBrZXkgPSBcIkRFQlVHR0VSX0xBU1RfVVNFRF9cIiArIGhvc3QgKyBcIl9cIiArIGFjdGlvblxyXG4gIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpXHJcbn1cclxuXHJcbi8vIE9sZGVyIHB1Ymxpc2hlZCBkZWJ1Z2dlciBwYWNrYWdlcyBkaWQgbm90IHByb3ZpZGUgYGdldFRhYk5hbWUoKWAuXHJcbi8vIFRPRE8obW9zdCk6IFJlbW92ZSB0aGlzIG9uY2UgbmV3ZXIgZGVidWdnZXIgdmVyc2lvbnMgZ2V0IGFkb3B0aW9uLlxyXG5mdW5jdGlvbiBnZXRUYWJOYW1lKHByb3ZpZGVyOiBEZWJ1Z2dlckxhdW5jaEF0dGFjaFByb3ZpZGVyKTogc3RyaW5nIHtcclxuICBpZiAodHlwZW9mIHByb3ZpZGVyLmdldFRhYk5hbWUgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgcmV0dXJuIHByb3ZpZGVyLmdldFRhYk5hbWUoKVxyXG4gIH1cclxuICByZXR1cm4gcHJvdmlkZXIuX2RlYnVnZ2luZ1R5cGVOYW1lID8/IFwiXCJcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGVidWdnZXJMYXVuY2hBdHRhY2hVSSBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxQcm9wcywgU3RhdGU+IHtcclxuICBwcm9wczogUHJvcHNcclxuICBzdGF0ZTogU3RhdGVcclxuICBfZGlzcG9zYWJsZXM6IFVuaXZlcnNhbERpc3Bvc2FibGVcclxuXHJcbiAgY29uc3RydWN0b3IocHJvcHM6IFByb3BzKSB7XHJcbiAgICBzdXBlcihwcm9wcylcclxuXHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlcyA9IG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKClcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGVzLmFkZChcclxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoXCJhdG9tLXdvcmtzcGFjZVwiLCB7XHJcbiAgICAgICAgXCJjb3JlOmNvbmZpcm1cIjogKCkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuc3RhdGUuY29uZmlnSXNWYWxpZCkge1xyXG4gICAgICAgICAgICB0aGlzLl9yZW1lbWJlclRhYigpXHJcblxyXG4gICAgICAgICAgICAvLyBDbG9zZSB0aGUgZGlhbG9nLCBidXQgZG8gaXQgb24gdGhlIG5leHQgdGljayBzbyB0aGF0IHRoZSBjaGlsZFxyXG4gICAgICAgICAgICAvLyBjb21wb25lbnQgZ2V0cyB0byBoYW5kbGUgdGhlIGV2ZW50IGZpcnN0IChhbmQgc3RhcnQgdGhlIGRlYnVnZ2VyKS5cclxuICAgICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayh0aGlzLnByb3BzLmRpYWxvZ0Nsb3NlcilcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICB9KSxcclxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoXCJhdG9tLXdvcmtzcGFjZVwiLCB7XHJcbiAgICAgICAgXCJjb3JlOmNhbmNlbFwiOiAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLl9yZW1lbWJlclRhYigpXHJcbiAgICAgICAgICB0aGlzLnByb3BzLmRpYWxvZ0Nsb3NlcigpXHJcbiAgICAgICAgfSxcclxuICAgICAgfSlcclxuICAgIClcclxuXHJcbiAgICB0aGlzLnN0YXRlID0ge1xyXG4gICAgICBzZWxlY3RlZFByb3ZpZGVyVGFiOiBudWxsLFxyXG4gICAgICBjb25maWdJc1ZhbGlkOiBmYWxzZSxcclxuICAgICAgZW5hYmxlZFByb3ZpZGVyczogW10sXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfcmVtZW1iZXJUYWIoKTogdm9pZCB7XHJcbiAgICAvLyBSZW1lbWJlciB0aGUgbGFzdCB0YWIgdGhlIHVzZXIgdXNlZCBmb3IgdGhpcyBjb25uZWN0aW9uIHdoZW4gdGhlIFwibGF1bmNoL2F0dGFjaFwiXHJcbiAgICAvLyBidXR0b24gaXMgY2xpY2tlZC5cclxuICAgIGNvbnN0IGhvc3QgPSBudWNsaWRlVXJpLmlzUmVtb3RlKHRoaXMucHJvcHMuY29ubmVjdGlvbikgPyBudWNsaWRlVXJpLmdldEhvc3RuYW1lKHRoaXMucHJvcHMuY29ubmVjdGlvbikgOiBcImxvY2FsXCJcclxuICAgIGlmICh0aGlzLnN0YXRlLnNlbGVjdGVkUHJvdmlkZXJUYWIgIT0gbnVsbCkge1xyXG4gICAgICBzZXRMYXN0VXNlZERlYnVnZ2VyKGhvc3QsIHRoaXMucHJvcHMuZGlhbG9nTW9kZSwgdGhpcy5zdGF0ZS5zZWxlY3RlZFByb3ZpZGVyVGFiIHx8IFwiXCIpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCkge1xyXG4gICAgY29uc3QgaG9zdCA9IG51Y2xpZGVVcmkuaXNSZW1vdGUodGhpcy5wcm9wcy5jb25uZWN0aW9uKSA/IG51Y2xpZGVVcmkuZ2V0SG9zdG5hbWUodGhpcy5wcm9wcy5jb25uZWN0aW9uKSA6IFwibG9jYWxcIlxyXG5cclxuICAgIGNvbnN0IHNlbGVjdGVkUHJvdmlkZXIgPSAodGhpcy5wcm9wcy5wcm92aWRlcnMuZ2V0KGhvc3QpIHx8IFtdKS5maW5kKFxyXG4gICAgICAocCkgPT4gZ2V0VGFiTmFtZShwKSA9PT0gdGhpcy5wcm9wcy5pbml0aWFsU2VsZWN0ZWRUYWJOYW1lXHJcbiAgICApXHJcbiAgICBpZiAoc2VsZWN0ZWRQcm92aWRlciAhPSBudWxsKSB7XHJcbiAgICAgIHNldExhc3RVc2VkRGVidWdnZXIoaG9zdCwgdGhpcy5wcm9wcy5kaWFsb2dNb2RlLCBnZXRUYWJOYW1lKHNlbGVjdGVkUHJvdmlkZXIpKVxyXG4gICAgfVxyXG4gICAgdGhpcy5fZmlsdGVyUHJvdmlkZXJzKGhvc3QpXHJcbiAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgc2VsZWN0ZWRQcm92aWRlclRhYjogZ2V0TGFzdFVzZWREZWJ1Z2dlcihob3N0LCB0aGlzLnByb3BzLmRpYWxvZ01vZGUpLFxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogUHJvcHMpIHtcclxuICAgIGNvbnN0IGhvc3QgPSBudWNsaWRlVXJpLmlzUmVtb3RlKG5leHRQcm9wcy5jb25uZWN0aW9uKSA/IG51Y2xpZGVVcmkuZ2V0SG9zdG5hbWUobmV4dFByb3BzLmNvbm5lY3Rpb24pIDogXCJsb2NhbFwiXHJcblxyXG4gICAgdGhpcy5fZmlsdGVyUHJvdmlkZXJzKGhvc3QpXHJcbiAgICB0aGlzLnNldFN0YXRlKHtcclxuICAgICAgc2VsZWN0ZWRQcm92aWRlclRhYjogZ2V0TGFzdFVzZWREZWJ1Z2dlcihob3N0LCBuZXh0UHJvcHMuZGlhbG9nTW9kZSksXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlcy5kaXNwb3NlKClcclxuICB9XHJcblxyXG4gIGFzeW5jIF9nZXRQcm92aWRlcklmRW5hYmxlZChwcm92aWRlcjogRGVidWdnZXJMYXVuY2hBdHRhY2hQcm92aWRlcik6IFByb21pc2U8P0RlYnVnZ2VyTGF1bmNoQXR0YWNoUHJvdmlkZXI+IHtcclxuICAgIGNvbnN0IGVuYWJsZWQgPSBhd2FpdCBwcm92aWRlci5nZXRDYWxsYmFja3NGb3JBY3Rpb24odGhpcy5wcm9wcy5kaWFsb2dNb2RlKS5pc0VuYWJsZWQoKVxyXG4gICAgcmV0dXJuIGVuYWJsZWQgPyBwcm92aWRlciA6IG51bGxcclxuICB9XHJcblxyXG4gIF9maWx0ZXJQcm92aWRlcnMoa2V5OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuc2V0U3RhdGUoe1xyXG4gICAgICBlbmFibGVkUHJvdmlkZXJzOiBbXSxcclxuICAgIH0pXHJcblxyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG51Y2xpZGUtaW50ZXJuYWwvdW51c2VkLXN1YnNjcmlwdGlvblxyXG4gICAgT2JzZXJ2YWJsZS5tZXJnZShcclxuICAgICAgLi4uKHRoaXMucHJvcHMucHJvdmlkZXJzLmdldChrZXkpIHx8IFtdKS5tYXAoKHByb3ZpZGVyKSA9PlxyXG4gICAgICAgIE9ic2VydmFibGUuZnJvbVByb21pc2UodGhpcy5fZ2V0UHJvdmlkZXJJZkVuYWJsZWQocHJvdmlkZXIpKVxyXG4gICAgICApXHJcbiAgICApXHJcbiAgICAgIC5maWx0ZXIoKHByb3ZpZGVyKSA9PiBwcm92aWRlciAhPSBudWxsKVxyXG4gICAgICAubWFwKChwcm92aWRlcikgPT4ge1xyXG4gICAgICAgIGludmFyaWFudChwcm92aWRlciAhPSBudWxsKVxyXG4gICAgICAgIGNvbnN0IHRhYk5hbWUgPSBnZXRUYWJOYW1lKHByb3ZpZGVyKVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBwcm92aWRlcixcclxuICAgICAgICAgIHRhYk5hbWUsXHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgICAuc2NhbigoYXJyLCBwcm92aWRlcikgPT4gYXJyLmNvbmNhdChwcm92aWRlciksIFtdKVxyXG4gICAgICAuc3Vic2NyaWJlKChlbmFibGVkUHJvdmlkZXJzKSA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGVuYWJsZWRQcm92aWRlcnMgfSlcclxuICAgICAgfSlcclxuICB9XHJcblxyXG4gIF9zZXRDb25maWdWYWxpZCA9ICh2YWxpZDogYm9vbGVhbik6IHZvaWQgPT4ge1xyXG4gICAgdGhpcy5zZXRTdGF0ZSh7XHJcbiAgICAgIGNvbmZpZ0lzVmFsaWQ6IHZhbGlkLFxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIF9nZXRUYWJzRnJvbUVuYWJsZWRQcm92aWRlcnMoZW5hYmxlZFByb3ZpZGVyczogRW5hYmxlZFByb3ZpZGVyW10pOiBUYWJbXSB7XHJcbiAgICBjb25zdCB0YWJzID0gdGhpcy5zdGF0ZS5lbmFibGVkUHJvdmlkZXJzXHJcbiAgICAgIC5tYXAoKGRlYnVnZ2VyVHlwZSkgPT4gKHtcclxuICAgICAgICBuYW1lOiBkZWJ1Z2dlclR5cGUudGFiTmFtZSxcclxuICAgICAgICB0YWJDb250ZW50OiAoXHJcbiAgICAgICAgICA8c3BhbiB0aXRsZT17ZGVidWdnZXJUeXBlLnRhYk5hbWV9IGNsYXNzTmFtZT1cImRlYnVnZ2VyLXByb3ZpZGVyLXRhYlwiPlxyXG4gICAgICAgICAgICB7ZGVidWdnZXJUeXBlLnRhYk5hbWV9XHJcbiAgICAgICAgICA8L3NwYW4+XHJcbiAgICAgICAgKSxcclxuICAgICAgfSkpXHJcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBhLm5hbWUubG9jYWxlQ29tcGFyZShiLm5hbWUpKVxyXG4gICAgcmV0dXJuIHRhYnNcclxuICB9XHJcblxyXG4gIHNldFN0YXRlKHBhcnRpYWxTdGF0ZTogJFNoYXBlPFN0YXRlPiB8ICgoU3RhdGUsIFByb3BzKSA9PiAkU2hhcGU8U3RhdGU+IHwgdm9pZCksIGNhbGxiYWNrPzogKCkgPT4gbWl4ZWQpOiB2b2lkIHtcclxuICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgc3VwZXIuc2V0U3RhdGUocGFydGlhbFN0YXRlLCBjYWxsYmFjaylcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGZ1bGxTdGF0ZSA9IHtcclxuICAgICAgICAuLi50aGlzLnN0YXRlLFxyXG4gICAgICAgIC4uLnBhcnRpYWxTdGF0ZSxcclxuICAgICAgfVxyXG4gICAgICBpZiAoZnVsbFN0YXRlLnNlbGVjdGVkUHJvdmlkZXJUYWIgPT0gbnVsbCkge1xyXG4gICAgICAgIGNvbnN0IHRhYnMgPSB0aGlzLl9nZXRUYWJzRnJvbUVuYWJsZWRQcm92aWRlcnMoZnVsbFN0YXRlLmVuYWJsZWRQcm92aWRlcnMpXHJcbiAgICAgICAgaWYgKHRhYnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgY29uc3QgZmlyc3RUYWIgPSB0YWJzWzBdXHJcbiAgICAgICAgICBmdWxsU3RhdGUuc2VsZWN0ZWRQcm92aWRlclRhYiA9IGZpcnN0VGFiLm5hbWVcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgc3VwZXIuc2V0U3RhdGUoZnVsbFN0YXRlLCBjYWxsYmFjaylcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlbmRlcigpOiBSZWFjdC5Ob2RlIHtcclxuICAgIGNvbnN0IHRhYnMgPSB0aGlzLl9nZXRUYWJzRnJvbUVuYWJsZWRQcm92aWRlcnModGhpcy5zdGF0ZS5lbmFibGVkUHJvdmlkZXJzKVxyXG4gICAgbGV0IHByb3ZpZGVyQ29udGVudCA9IG51bGxcclxuICAgIGlmICh0YWJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgbGV0IHNlbGVjdGVkVGFiID1cclxuICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvdmlkZXJUYWIgIT0gbnVsbCA/IHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm92aWRlclRhYiA6IHRoaXMuc3RhdGUuZW5hYmxlZFByb3ZpZGVyc1swXS50YWJOYW1lXHJcbiAgICAgIGxldCBwcm92aWRlciA9IHRoaXMuc3RhdGUuZW5hYmxlZFByb3ZpZGVycy5maW5kKChwKSA9PiBwLnRhYk5hbWUgPT09IHNlbGVjdGVkVGFiKVxyXG4gICAgICBpZiAocHJvdmlkZXIgPT0gbnVsbCkge1xyXG4gICAgICAgIHByb3ZpZGVyID0gdGhpcy5zdGF0ZS5lbmFibGVkUHJvdmlkZXJzWzBdXHJcbiAgICAgICAgc2VsZWN0ZWRUYWIgPSBwcm92aWRlci50YWJOYW1lXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGRlZmF1bHRDb25maWcgPVxyXG4gICAgICAgIHNlbGVjdGVkVGFiICE9IG51bGwgJiYgc2VsZWN0ZWRUYWIgPT09IHRoaXMucHJvcHMuaW5pdGlhbFNlbGVjdGVkVGFiTmFtZVxyXG4gICAgICAgICAgPyB0aGlzLnByb3BzLmluaXRpYWxQcm92aWRlckNvbmZpZ1xyXG4gICAgICAgICAgOiBudWxsXHJcblxyXG4gICAgICBjb25zdCBkZWJ1Z2dlckNvbmZpZ1BhZ2UgPSBwcm92aWRlci5wcm92aWRlclxyXG4gICAgICAgIC5nZXRDYWxsYmFja3NGb3JBY3Rpb24odGhpcy5wcm9wcy5kaWFsb2dNb2RlKVxyXG4gICAgICAgIC5nZXRDb21wb25lbnQoc2VsZWN0ZWRUYWIsICh2YWxpZCkgPT4gdGhpcy5fc2V0Q29uZmlnVmFsaWQodmFsaWQpLCBkZWZhdWx0Q29uZmlnKVxyXG5cclxuICAgICAgcHJvdmlkZXJDb250ZW50ID0gKFxyXG4gICAgICAgIDxkaXY+XHJcbiAgICAgICAgICA8VGFic1xyXG4gICAgICAgICAgICBjbGFzc05hbWU9XCJkZWJ1Z2dlci1sYXVuY2gtYXR0YWNoLXRhYnNcIlxyXG4gICAgICAgICAgICB0YWJzPXt0YWJzfVxyXG4gICAgICAgICAgICBncm93YWJsZT17dHJ1ZX1cclxuICAgICAgICAgICAgYWN0aXZlVGFiTmFtZT17dGhpcy5zdGF0ZS5zZWxlY3RlZFByb3ZpZGVyVGFifVxyXG4gICAgICAgICAgICB0cmlnZ2VyaW5nRXZlbnQ9XCJvbkNsaWNrXCJcclxuICAgICAgICAgICAgb25BY3RpdmVUYWJDaGFuZ2U9eyhuZXdUYWIpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLl9zZXRDb25maWdWYWxpZChmYWxzZSlcclxuICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgc2VsZWN0ZWRQcm92aWRlclRhYjogbmV3VGFiLm5hbWUgfSlcclxuICAgICAgICAgICAgfX1cclxuICAgICAgICAgIC8+XHJcbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImRlYnVnZ2VyLWxhdW5jaC1hdHRhY2gtdGFiY29udGVudFwiPntkZWJ1Z2dlckNvbmZpZ1BhZ2V9PC9kaXY+XHJcbiAgICAgICAgPC9kaXY+XHJcbiAgICAgIClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIE5vIGRlYnVnZ2luZyBwcm92aWRlcnMgYXZhaWxhYmxlLlxyXG4gICAgICBwcm92aWRlckNvbnRlbnQgPSAoXHJcbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJkZWJ1Z2dlci1sYXVuY2gtYXR0YWNoLXRhYmNvbnRlbnRcIj5cclxuICAgICAgICAgIE5vIGRlYnVnZ2VycyBpbnN0YWxsZWQsIGxvb2sgZm9yIGF2YWlsYWJsZSBkZWJ1Z2dlcnMgb257XCIgXCJ9XHJcbiAgICAgICAgICA8YSBocmVmPVwiaHR0cHM6Ly9hdG9tLmlvL3BhY2thZ2VzL3NlYXJjaD9xPWF0b20taWRlLWRlYnVnZ2VyLVwiPmF0b20uaW8vcGFja2FnZXM8L2E+XHJcbiAgICAgICAgPC9kaXY+XHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gKFxyXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cInBhZGRlZCBkZWJ1Z2dlci1sYXVuY2gtYXR0YWNoLWNvbnRhaW5lclwiPlxyXG4gICAgICAgIHtpc051Y2xpZGVFbnZpcm9ubWVudCgpID8gKFxyXG4gICAgICAgICAgPGgxIGNsYXNzTmFtZT1cImRlYnVnZ2VyLWxhdW5jaC1hdHRhY2gtaGVhZGVyXCI+XHJcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cInBhZGRlZFwiPlxyXG4gICAgICAgICAgICAgIHt0aGlzLnByb3BzLmRpYWxvZ01vZGUgPT09IFwiYXR0YWNoXCIgPyBcIkF0dGFjaCBkZWJ1Z2dlciB0byBcIiA6IFwiTGF1bmNoIGRlYnVnZ2VyIG9uIFwifVxyXG4gICAgICAgICAgICA8L3NwYW4+XHJcbiAgICAgICAgICAgIDxEcm9wZG93blxyXG4gICAgICAgICAgICAgIGNsYXNzTmFtZT1cImlubGluZVwiXHJcbiAgICAgICAgICAgICAgb3B0aW9ucz17dGhpcy5wcm9wcy5jb25uZWN0aW9uT3B0aW9uc31cclxuICAgICAgICAgICAgICBvbkNoYW5nZT17KHZhbHVlOiA/c3RyaW5nKSA9PiB0aGlzLnByb3BzLmNvbm5lY3Rpb25DaGFuZ2VkKHZhbHVlKX1cclxuICAgICAgICAgICAgICBzaXplPVwieHNcIlxyXG4gICAgICAgICAgICAgIHZhbHVlPXt0aGlzLnByb3BzLmNvbm5lY3Rpb259XHJcbiAgICAgICAgICAgIC8+XHJcbiAgICAgICAgICA8L2gxPlxyXG4gICAgICAgICkgOiBudWxsfVxyXG4gICAgICAgIHtwcm92aWRlckNvbnRlbnR9XHJcbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJkZWJ1Z2dlci1sYXVuY2gtYXR0YWNoLWFjdGlvbnNcIj5cclxuICAgICAgICAgIDxCdXR0b25Hcm91cD5cclxuICAgICAgICAgICAgPEJ1dHRvbiBvbkNsaWNrPXsoKSA9PiBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSksIFwiY29yZTpjYW5jZWxcIil9PlxyXG4gICAgICAgICAgICAgIENhbmNlbFxyXG4gICAgICAgICAgICA8L0J1dHRvbj5cclxuICAgICAgICAgICAgPEJ1dHRvblxyXG4gICAgICAgICAgICAgIGJ1dHRvblR5cGU9e0J1dHRvblR5cGVzLlBSSU1BUll9XHJcbiAgICAgICAgICAgICAgZGlzYWJsZWQ9eyF0aGlzLnN0YXRlLmNvbmZpZ0lzVmFsaWR9XHJcbiAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gYXRvbS5jb21tYW5kcy5kaXNwYXRjaChhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLCBcImNvcmU6Y29uZmlybVwiKX1cclxuICAgICAgICAgICAgPlxyXG4gICAgICAgICAgICAgIHt0aGlzLnByb3BzLmRpYWxvZ01vZGUgPT09IFwiYXR0YWNoXCIgPyBcIkF0dGFjaFwiIDogXCJMYXVuY2hcIn1cclxuICAgICAgICAgICAgPC9CdXR0b24+XHJcbiAgICAgICAgICA8L0J1dHRvbkdyb3VwPlxyXG4gICAgICAgIDwvZGl2PlxyXG4gICAgICA8L2Rpdj5cclxuICAgIClcclxuICB9XHJcbn1cclxuIl19